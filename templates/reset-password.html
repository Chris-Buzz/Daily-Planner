<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Reset Password - Planno</title>
  <link rel="icon" type="image/png" href="/static/PlannerIcon.png">
  <link rel="stylesheet" href="/static/login.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div id="auth-box">
    <h2>Reset Your Password</h2>
    <p class="subtitle">Enter your new password for Planno</p>

    <!-- Password Reset Form -->
    <form id="reset-password-form">
      <input id="new-password" type="password" placeholder="New password (min 6 characters)" required autocomplete="new-password" />
      <input id="confirm-password" type="password" placeholder="Confirm new password" required autocomplete="new-password" />
      
      <div class="password-strength">
        <div class="strength-bar" id="strength-bar"></div>
      </div>
      <p class="password-hint" id="password-hint">Password must be at least 6 characters</p>
      
      <button type="submit" id="btn-reset">Reset Password</button>
    </form>

    <div class="signup-link">
      Remember your password? <a href="/login">Sign in</a>
    </div>

    <div id="auth-status"></div>
    
    <!-- Loading indicator -->
    <div id="loading">
      <div class="loading-spinner"></div>
      <p>Resetting your password...</p>
    </div>

    <div class="privacy-footer">
      <a href="/privacy">Privacy Policy</a>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>

  <script>
    // Helper Functions
    const statusEl = document.getElementById("auth-status");
    const loadingEl = document.getElementById("loading");
    const resetForm = document.getElementById("reset-password-form");
    const strengthBar = document.getElementById("strength-bar");
    const passwordHint = document.getElementById("password-hint");

    const showMessage = (message, isError = false) => {
      statusEl.innerHTML = `<div class="${isError ? 'auth-error' : 'auth-success'}">${message}</div>`;
      setTimeout(() => {
        statusEl.innerHTML = '';
      }, 8000);
    };

    const showLoading = (show) => {
      loadingEl.style.display = show ? 'flex' : 'none';
      loadingEl.style.flexDirection = 'column';
      loadingEl.style.alignItems = 'center';
      
      const btn = document.getElementById('btn-reset');
      if (btn) btn.disabled = show;
    };

    const validatePassword = (password) => {
      return password.length >= 6;
    };

    const getPasswordStrength = (password) => {
      let strength = 0;
      if (password.length >= 6) strength += 25;
      if (password.length >= 10) strength += 25;
      if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 25;
      if (/[0-9]/.test(password)) strength += 12.5;
      if (/[^a-zA-Z0-9]/.test(password)) strength += 12.5;
      return Math.min(strength, 100);
    };

    const updatePasswordStrength = (password) => {
      const strength = getPasswordStrength(password);
      strengthBar.style.width = `${strength}%`;
      
      if (strength < 25) {
        strengthBar.style.backgroundColor = '#EF4444';
        passwordHint.textContent = 'Weak password';
        passwordHint.style.color = '#EF4444';
      } else if (strength < 50) {
        strengthBar.style.backgroundColor = '#F59E0B';
        passwordHint.textContent = 'Fair password';
        passwordHint.style.color = '#F59E0B';
      } else if (strength < 75) {
        strengthBar.style.backgroundColor = '#10B981';
        passwordHint.textContent = 'Good password';
        passwordHint.style.color = '#10B981';
      } else {
        strengthBar.style.backgroundColor = '#10B981';
        passwordHint.textContent = 'Strong password!';
        passwordHint.style.color = '#10B981';
      }
    };

    // Get oobCode from URL
    const urlParams = new URLSearchParams(window.location.search);
    const oobCode = urlParams.get('oobCode');
    const mode = urlParams.get('mode');

    if (!oobCode || mode !== 'resetPassword') {
      showMessage('Invalid or expired password reset link. Please request a new one.', true);
      setTimeout(() => {
        window.location.href = '/login';
      }, 3000);
    }

    (async () => {
      try {
        // Fetch Firebase config from server
        const configResponse = await fetch("/api/firebase-config");
        if (!configResponse.ok) {
          throw new Error("Failed to load configuration");
        }
        const firebaseConfig = await configResponse.json();

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // Verify the reset code is valid
        try {
          await auth.verifyPasswordResetCode(oobCode);
          console.log('✅ Password reset code verified');
        } catch (error) {
          showMessage('This password reset link is invalid or has expired. Please request a new one.', true);
          setTimeout(() => {
            window.location.href = '/login';
          }, 3000);
          return;
        }

        // Password strength indicator
        const newPasswordInput = document.getElementById('new-password');
        newPasswordInput.addEventListener('input', (e) => {
          updatePasswordStrength(e.target.value);
        });

        // Handle form submission
        resetForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const newPassword = document.getElementById('new-password').value;
          const confirmPassword = document.getElementById('confirm-password').value;

          // Validation
          if (!validatePassword(newPassword)) {
            showMessage('Password must be at least 6 characters long.', true);
            return;
          }

          if (newPassword !== confirmPassword) {
            showMessage('Passwords do not match. Please try again.', true);
            return;
          }

          showLoading(true);

          try {
            // Confirm the password reset
            await auth.confirmPasswordReset(oobCode, newPassword);
            
            showLoading(false);
            showMessage('✅ Password reset successful! Redirecting to login...', false);
            
            // Redirect to login page after success
            setTimeout(() => {
              window.location.href = '/login';
            }, 2000);

          } catch (error) {
            showLoading(false);
            console.error('Password reset error:', error);

            let errorMessage = 'Failed to reset password. Please try again.';
            
            if (error.code === 'auth/weak-password') {
              errorMessage = 'Password is too weak. Please use a stronger password.';
            } else if (error.code === 'auth/expired-action-code') {
              errorMessage = 'This password reset link has expired. Please request a new one.';
            } else if (error.code === 'auth/invalid-action-code') {
              errorMessage = 'This password reset link is invalid. Please request a new one.';
            }

            showMessage(errorMessage, true);
          }
        });

        // Input validation styling
        const inputs = document.querySelectorAll('input[type="password"]');
        inputs.forEach(input => {
          input.addEventListener('focus', () => {
            input.style.borderColor = 'var(--primary)';
          });
          
          input.addEventListener('blur', () => {
            if (!input.value) {
              input.style.borderColor = '';
              return;
            }
            
            if (input.id === 'new-password') {
              input.style.borderColor = validatePassword(input.value) ? 'var(--success)' : 'var(--danger)';
            } else if (input.id === 'confirm-password') {
              const newPassword = document.getElementById('new-password').value;
              input.style.borderColor = input.value === newPassword ? 'var(--success)' : 'var(--danger)';
            }
          });
        });

      } catch (error) {
        console.error('❌ Firebase initialization failed:', error);
        showMessage('Configuration error. Please contact support.', true);
        return;
      }
    })();
  </script>
</body>
</html>
